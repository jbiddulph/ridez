import{r as b,m as R,x as Y,s as U,q as S,I as G,A as K,c as d,B as q,o as u,a as e,t as l,n as F,y as H,z as M,J as Q,b as W,k as B,K as V,L as m,M as J,F as C,j as L,d as X,v as Z}from"./7GWaBXbZ.js";import{u as O}from"./TCo5-zK6.js";const ee={key:0,class:"fixed inset-0 z-50 overflow-y-auto"},te={class:"flex min-h-full items-center justify-center p-4"},se={class:"relative w-full max-w-4xl bg-white rounded-lg shadow-xl"},oe={class:"flex items-center justify-between p-6 border-b"},re={class:"text-2xl font-semibold text-gray-900"},ne={class:"mx-6 my-2"},ae={class:"grid grid-cols-2 gap-4"},le={class:"text-left"},ie={class:"text-sm text-gray-500"},ce={class:"text-right"},de={class:"h-80 overflow-hidden border border-gray-200 relative"},ue={class:"p-6"},ge={class:"grid grid-cols-1 gap-3"},pe={class:"grid grid-cols-3 md:grid-cols-3 gap-3 mb-6"},me={class:"flex flex-col items-center"},ye={class:"text-2xl text-gray-900 font-bold"},fe={class:"flex flex-col items-center border-x border-gray-200"},xe={class:"text-2xl text-gray-900 font-bold"},he={class:"flex flex-col items-center"},ve={class:"text-2xl text-gray-900 font-bold"},_e={key:0},be={key:1},ke={class:"text-center"},we={key:0,class:"text-gray-600"},$e={key:1,class:"text-gray-500 italic"},De={__name:"TripDetailsModal",props:{isOpen:Boolean,trip:Object},emits:["close"],setup(g,{emit:T}){const f=g,D=T,x=b(null);let n=null;const k=R(),E=O(),$=b("GBP"),h=async()=>{if(!k.value)return;const{data:i}=await E.from("ridez_settings").select("currency").eq("user_id",k.value.id).single();i&&i.currency&&($.value=i.currency)};Y(h),U(k,h);const v=S(()=>{switch(($.value||"").toUpperCase()){case"GBP":return"£";case"USD":return"$";case"EUR":return"€";case"AUD":return"A$";case"CAD":return"C$";default:return $.value||"£"}});G("currencySymbol",v);const w=()=>{D("close")},z=i=>i?`${(i/1609.344).toFixed(2)}mi`:"N/A",N=S(()=>{var a,o;if(!((a=f.trip)!=null&&a.created_at)||!((o=f.trip)!=null&&o.end_time))return"N/A";const i=new Date(f.trip.created_at),y=new Date(f.trip.end_time)-i,_=Math.floor(y/(1e3*60*60)),s=Math.floor(y%(1e3*60*60)/(1e3*60)),t=Math.floor(y%(1e3*60)/1e3);return _>0?`${_}h ${s}m ${t}s`:s>0?`${s}m ${t}s`:`${t}s`}),j=async()=>{if(console.log("Initializing map..."),console.log("Map container:",x.value),console.log("Trip data:",f.trip),!x.value){console.error("Map container not found");return}try{const i=H();console.log("Mapbox token:",i.public.mapboxToken?"Token exists":"No token"),M.accessToken=i.public.mapboxToken;const{data:r,error:y}=await O().from("ridez_routes").select("latitude, longitude, sequence_number").eq("ride_id",f.trip.id).order("sequence_number",{ascending:!0});if(y){console.error("Error fetching route points:",y);return}if(!r||r.length===0){console.error("No route points found");return}const _=Math.floor(r.length/2),s=r[_];n=new M.Map({container:x.value,style:"mapbox://styles/mapbox/streets-v12",center:[s.longitude,s.latitude],zoom:13}),n.on("load",()=>{console.log("Map loaded successfully"),n.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:r.map(p=>[p.longitude,p.latitude])}}}),n.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":4}});const t=r[0],a=r[r.length-1];new M.Marker({color:"#22c55e"}).setLngLat([t.longitude,t.latitude]).addTo(n),new M.Marker({color:"#ef4444"}).setLngLat([a.longitude,a.latitude]).addTo(n);const o=r.reduce((p,c)=>p.extend([c.longitude,c.latitude]),new M.LngLatBounds);n.fitBounds(o,{padding:50,duration:1e3})}),n.on("error",t=>{console.error("Map error:",t)})}catch(i){console.error("Error initializing map:",i)}};return U(()=>f.isOpen,i=>{console.log("Modal open state changed:",i),i?setTimeout(()=>{j()},100):n&&(n.remove(),n=null)}),K(()=>{console.log("Component unmounting, cleaning up map"),n&&(n.remove(),n=null)}),(i,r)=>{var y,_,s,t,a,o,p,c,A,P,I;return g.isOpen?(u(),d("div",ee,[e("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:w}),e("div",te,[e("div",se,[e("div",oe,[e("h3",re,l((y=g.trip)==null?void 0:y.title),1),e("button",{onClick:w,class:"text-gray-400 hover:text-gray-500"},r[0]||(r[0]=[e("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),e("div",null,[e("div",ne,[e("div",ae,[e("div",le,[e("p",ie,l((_=g.trip)!=null&&_.created_at?new Date(g.trip.created_at).toLocaleDateString():"")+" at "+l((s=g.trip)!=null&&s.created_at?new Date(g.trip.created_at).toLocaleTimeString():""),1)]),e("div",ce,[e("span",{class:F(["inline-block px-3 py-1 text-sm rounded-full",{"bg-green-100 text-green-800":((t=g.trip)==null?void 0:t.transport_type)==="walk","bg-blue-100 text-blue-800":((a=g.trip)==null?void 0:a.transport_type)==="cycle","bg-purple-100 text-purple-800":((o=g.trip)==null?void 0:o.transport_type)==="drive"}])},l((p=g.trip)==null?void 0:p.transport_type),3)])])])]),e("div",de,[e("div",{ref_key:"mapContainer",ref:x,class:"w-full h-full z-[60] bg-gray-100"},null,512)]),e("div",ue,[e("div",ge,[e("div",pe,[e("div",me,[r[1]||(r[1]=e("dt",{class:"text-sm font-medium text-gray-500"},"Duration",-1)),e("dd",ye,l(N.value),1)]),e("div",fe,[r[2]||(r[2]=e("dt",{class:"text-sm font-medium text-gray-500"},"Distance",-1)),e("dd",xe,l(z((c=g.trip)==null?void 0:c.distance)),1)]),e("div",he,[r[3]||(r[3]=e("dt",{class:"text-sm font-medium text-gray-500"},"Amount",-1)),e("dd",ve,[((A=g.trip)==null?void 0:A.amount)!==void 0&&((P=g.trip)==null?void 0:P.amount)!==null?(u(),d("span",_e,l(v.value)+l(g.trip.amount),1)):(u(),d("span",be,"N/A"))])])]),e("div",ke,[r[4]||(r[4]=e("h4",{class:"text-lg font-medium text-gray-900 mb-2"},"Notes",-1)),(I=g.trip)!=null&&I.notes?(u(),d("p",we,l(g.trip.notes),1)):(u(),d("p",$e,"No notes for this trip"))])])])])])])):q("",!0)}}},Me={class:"min-h-screen bg-gray-100 dark:bg-gray-900 py-12"},Se={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"},Te={class:"bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg shadow-lg"},Ce={class:"p-6 border-b"},Le={class:"flex justify-between items-center"},Ee={class:"flex space-x-4"},ze=["value"],Ne=["value"],je={class:"p-6 overflow-y-auto"},Ae={key:0,class:"text-center py-4"},Be={key:1,class:"text-red-600 p-4 bg-red-100 rounded-lg"},Ue={key:2,class:"text-center py-8 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"},qe={key:3,class:"space-y-4"},Fe=["onClick"],Oe={class:"flex items-center"},Pe={class:"text-xl font-semibold bg-white dark:bg-gray-800 text-gray-900 dark:text-white"},Ie={class:"ml-2 text-sm font-normal text-gray-500"},Ve={class:"ml-6 flex-shrink-0"},Je={class:"space-y-4"},Re=["onClick"],Ye={class:"flex justify-between items-start"},Ge={class:"font-semibold text-lg"},Ke={class:"text-sm text-gray-700 dark:text-gray-300"},He={class:"text-right"},Qe={class:"mt-2 text-sm text-gray-700 dark:text-gray-300"},We={key:0},Xe={key:1,class:"mt-1"},tt={__name:"trips",setup(g){const T=O(),f=R();Q();const D=b([]),x=b(!0),n=b(""),k=b(null),E=["January","February","March","April","May","June","July","August","September","October","November","December"],$=new Date,h=b($.getMonth()),v=b($.getFullYear()),w=b({}),z=S(()=>{const s=new Date().getFullYear();return Array.from({length:6},(t,a)=>s-a)}),N=s=>new Date(s).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),j=s=>{w.value[s]=!w.value[s]};Y(async()=>{try{if(!f.value){n.value="Please sign in to view your trips",x.value=!1;return}await i()}catch(s){console.error("Error fetching trips:",s),n.value="Error loading trips: "+s.message}finally{x.value=!1}});const i=async()=>{try{x.value=!0;const s=new Date(v.value,h.value,1),t=new Date(v.value,h.value+1,0),{data:a,error:o}=await T.from("ridez_rides").select("*").eq("user_id",f.value.id).gte("created_at",s.toISOString()).lte("created_at",t.toISOString()).order("created_at",{ascending:!1});if(o)throw o;D.value=a}catch(s){console.error("Error fetching trips:",s),n.value="Error loading trips: "+s.message}finally{x.value=!1}};U([h,v],()=>{w.value={},i()});const r=S(()=>D.value),y=S(()=>{const s={};return D.value.forEach(t=>{const o=new Date(t.created_at).toISOString().split("T")[0];s[o]||(s[o]=[]),s[o].push(t)}),s}),_=async s=>{var t;try{const{data:a,error:o}=await T.from("ridez_rides").select("*, ridez_routes(*)").eq("id",s.id).single();if(o)throw o;k.value={...a,route:((t=a.ridez_routes)==null?void 0:t.coordinates)||[]}}catch(a){console.error("Error fetching trip details:",a),n.value="Error loading trip details: "+a.message}};return(s,t)=>{const a=De;return u(),d("div",Me,[e("div",Se,[e("div",Te,[e("div",Ce,[e("div",Le,[t[3]||(t[3]=e("h1",{class:"text-3xl font-bold"},"Trips",-1)),e("div",Ee,[B(e("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>J(h)?h.value=o:null),class:"rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2"},[(u(),d(C,null,L(E,(o,p)=>e("option",{key:p,value:p},l(o),9,ze)),64))],512),[[V,m(h)]]),B(e("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>J(v)?v.value=o:null),class:"rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2"},[(u(!0),d(C,null,L(m(z),o=>(u(),d("option",{key:o,value:o},l(o),9,Ne))),128))],512),[[V,m(v)]])])])]),e("div",je,[m(x)?(u(),d("div",Ae,t[4]||(t[4]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"},null,-1),e("p",{class:"mt-2 text-gray-900 dark:text-gray-100"},"Loading trips...",-1)]))):m(n)?(u(),d("div",Be,l(m(n)),1)):m(r).length===0?(u(),d("div",Ue," No trips recorded for the selected period. Start tracking your first trip! ")):(u(),d("div",qe,[(u(!0),d(C,null,L(m(y),(o,p)=>(u(),d("div",{key:p,class:"border-b last:border-b-0"},[e("button",{onClick:c=>j(p),class:"w-full text-left flex justify-between items-center py-4 focus:outline-none"},[e("div",Oe,[e("h2",Pe,[X(l(N(p))+" ",1),e("span",Ie," ("+l(o.length)+" "+l(o.length===1?"trip":"trips")+") ",1)])]),e("span",Ve,[(u(),d("svg",{class:F(["h-6 w-6 transform transition-transform duration-200",{"rotate-180":m(w)[p]}]),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},t[5]||(t[5]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))])],8,Fe),B(e("div",null,[e("div",Je,[(u(!0),d(C,null,L(o,c=>(u(),d("div",{key:c.id,class:"border rounded-lg p-4 hover:bg-gray-500 cursor-pointer transition-colors duration-150",onClick:A=>_(c)},[e("div",Ye,[e("div",null,[e("h3",Ge,l(c.title),1),e("p",Ke,l(new Date(c.created_at).toLocaleTimeString()),1)]),e("div",He,[e("span",{class:F(["inline-block px-2 py-1 text-xs rounded-full",{"bg-green-300 text-green-800":c.transport_type==="walk","bg-blue-300 text-blue-800":c.transport_type==="cycle","bg-purple-300 text-purple-800":c.transport_type==="drive"}])},l(c.transport_type),3)])]),e("div",Qe,[c.amount?(u(),d("p",We,l(c.transaction_type==="spending"?"Spent":"Earned")+": £"+l(c.amount),1)):q("",!0),c.notes?(u(),d("p",Xe,l(c.notes),1)):q("",!0)])],8,Re))),128))])],512),[[Z,m(w)[p]]])]))),128))]))])])]),W(a,{"is-open":!!m(k),trip:m(k),onClose:t[2]||(t[2]=o=>k.value=null)},null,8,["is-open","trip"])])}}};export{tt as default};
